name: Release

# Triggers on version tags, e.g. v1.2.3
on:
  push:
    tags: ['v*.*.*']

# Need write access to packages (GHCR) and contents (GitHub Release).
permissions:
  contents: write # create GitHub Release
  packages: write # push to GHCR
  id-token: write # npm provenance attestation

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1 — Re-run the full CI suite on the exact tagged commit
  # ──────────────────────────────────────────────────────────────────────────
  ci:
    name: CI (all checks)
    uses: ./.github/workflows/ci.yml

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2 — Publish to GitHub Packages (OIDC / Trusted Publishing)
  #
  # GitHub Packages is the npm-compatible registry that supports true
  # Trusted Publishing: authentication uses the auto-provisioned GITHUB_TOKEN
  # (a short-lived OIDC credential) — no long-lived NPM_TOKEN secret required.
  #
  # Install from GitHub Packages:
  #   npm install @prokodo/cli --registry https://npm.pkg.github.com
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm:
    name: Publish — GitHub Packages (OIDC)
    runs-on: ubuntu-latest
    needs: ci
    # Optional: gate on manual approval via GitHub Environments
    # environment: npm-publish

    permissions:
      contents: read
      packages: write # push to GitHub Packages registry
      id-token: write # OIDC token for provenance attestation

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          # GitHub Packages npm registry — authentication via GITHUB_TOKEN (OIDC)
          registry-url: https://npm.pkg.github.com

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4.2.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # Guard: ensure the git tag (e.g. v1.2.3) matches package.json version
      - name: Verify tag matches package.json version
        shell: bash
        run: |
          PKG=$(node -p "require('./package.json').version")
          TAG=${GITHUB_REF_NAME#v}
          if [ "$PKG" != "$TAG" ]; then
            echo "❌  Tag (v${TAG}) does not match package.json (${PKG})" && exit 1
          fi
          echo "✅  Version: ${PKG}"

      # Pack the tarball explicitly so we can (a) attest it and (b) publish
      # the exact same bytes that were attested — no rebuild on publish.
      - name: Pack npm tarball
        id: pack
        shell: bash
        run: |
          TARBALL=$(pnpm pack --json | node -e \
            "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d)[0].filename)")
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      # Creates a GitHub-side SLSA provenance attestation for the tarball.
      # Verifiable with: gh attestation verify <tarball> --repo <owner/repo>
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3.2.0
        with:
          subject-path: ${{ steps.pack.outputs.tarball }}

      # Publish using GITHUB_TOKEN — no NPM_TOKEN secret needed.
      # The short-lived token is auto-provisioned by GitHub Actions (OIDC).
      - name: Publish to GitHub Packages
        shell: bash
        run: npm publish --access public --provenance ${{ steps.pack.outputs.tarball }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3 — Build Docker image and push to GitHub Container Registry
  # ──────────────────────────────────────────────────────────────────────────
  publish-docker:
    name: Publish — Docker (GHCR)
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GHCR
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate semantic-version tags automatically from the git tag
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ghcr.io/${{ github.repository_owner }}/prokodo-cli
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ──────────────────────────────────────────────────────────────────────────
  # Job 4 — Create GitHub Release with auto-generated changelog
  # ──────────────────────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-docker]

    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0 # full history for changelog generation

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ github.ref_name }}
          generate_release_notes: true
          make_latest: true
