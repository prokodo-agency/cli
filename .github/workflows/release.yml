name: Release

# Triggers on version tags, e.g. v1.2.3
on:
  push:
    tags: ['v*.*.*']

# Minimal top-level permissions — each job declares only what it needs.
permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1 — Publish to npmjs.com (public registry)
  #
  # Requires a secret named NPM_TOKEN (classic Automation token from npmjs.com)
  # stored in repo Settings → Secrets and variables → Actions.
  #
  # Install:
  #   npm install -g @prokodo-agency/cli
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm:
    name: Publish — npmjs.com
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # SLSA provenance attestation

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          registry-url: https://registry.npmjs.org

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4.2.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Verify tag matches package.json version
        shell: bash
        run: |
          PKG=$(node -p "require('./package.json').version")
          TAG=${GITHUB_REF_NAME#v}
          if [ "$PKG" != "$TAG" ]; then
            echo "❌  Tag (v${TAG}) does not match package.json (${PKG})" && exit 1
          fi
          echo "✅  Version: ${PKG}"

      # Pack once — the same tarball is attested, published, and later
      # attached to the GitHub Release as a public download for Homebrew.
      - name: Pack npm tarball
        id: pack
        shell: bash
        run: |
          TARBALL=$(pnpm pack --json | node -e \
            "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d)[0].filename)")
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      # SLSA provenance — verifiable with:
      #   gh attestation verify <tarball> --repo prokodo-agency/cli
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3.2.0
        with:
          subject-path: ${{ steps.pack.outputs.tarball }}

      - name: Publish to npmjs.com
        shell: bash
        # publishConfig in package.json points to GitHub Packages; override it here.
        run: npm publish --access public --registry https://registry.npmjs.org ${{ steps.pack.outputs.tarball }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Share the tarball with downstream jobs (github-release, update-homebrew)
      - name: Upload tarball as workflow artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: npm-tarball
          path: ${{ steps.pack.outputs.tarball }}
          retention-days: 1

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2 — Publish to GitHub Packages (GITHUB_TOKEN — no secrets required)
  #
  # Install:
  #   npm install @prokodo-agency/cli --registry https://npm.pkg.github.com
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm-gpr:
    name: Publish — GitHub Packages
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write # push to GitHub Packages

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          registry-url: https://npm.pkg.github.com

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4.2.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Publish to GitHub Packages
        shell: bash
        run: pnpm publish --no-git-checks --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3 — Build Docker image and push to GitHub Container Registry
  # ──────────────────────────────────────────────────────────────────────────
  publish-docker:
    name: Publish — Docker (GHCR)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GHCR
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ghcr.io/${{ github.repository_owner }}/prokodo-cli
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ──────────────────────────────────────────────────────────────────────────
  # Job 4 — Create GitHub Release and attach the tarball as a public asset.
  # Waits for all three publish jobs so the release is only created after all
  # artifacts have been successfully published.
  # ──────────────────────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-npm-gpr, publish-docker]

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Download tarball artifact
        uses: actions/download-artifact@v4.2.1
        with:
          name: npm-tarball

      - name: Create GitHub Release (attach tarball)
        uses: softprops/action-gh-release@v2.5.0
        with:
          name: ${{ github.ref_name }}
          generate_release_notes: true
          make_latest: true
          files: '*.tgz'

  # ──────────────────────────────────────────────────────────────────────────
  # Job 5 — Auto-update the Homebrew tap formula.
  # Points to the GitHub Release asset (public URL, no registry auth needed).
  #
  # TAP_GITHUB_TOKEN: classic PAT (repo scope) from any org member who has
  # write access to prokodo-agency/homebrew-tap.
  # ──────────────────────────────────────────────────────────────────────────
  update-homebrew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    needs: github-release

    steps:
      - name: Compute release asset URL and sha256
        id: info
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          TARBALL="prokodo-cli-${VERSION}.tgz"
          URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${TARBALL}"
          SHA256=$(curl -fsSL "$URL" | shasum -a 256 | awk '{print $1}')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}"         >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}"   >> "$GITHUB_OUTPUT"

      - name: Checkout prokodo-agency/homebrew-tap
        uses: actions/checkout@v6.0.2
        with:
          repository: prokodo-agency/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        shell: bash
        run: |
          cd homebrew-tap
          sed -i "s|url \".*\"|url \"${{ steps.info.outputs.url }}\"|"             Formula/prokodo-cli.rb
          sed -i "s|sha256 \".*\"|sha256 \"${{ steps.info.outputs.sha256 }}\"|"   Formula/prokodo-cli.rb
          sed -i "s|version \".*\"|version \"${{ steps.info.outputs.version }}\"|" Formula/prokodo-cli.rb

      - name: Commit and push to tap
        shell: bash
        run: |
          cd homebrew-tap
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/prokodo-cli.rb
          git diff --staged --quiet || git commit -m "chore: update prokodo-cli to ${{ github.ref_name }}"
          git push
