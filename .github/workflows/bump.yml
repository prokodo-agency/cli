name: Bump version

# Manual trigger from the GitHub Actions UI.
# Pick the bump type → workflow commits the version change, tags it, and
# pushes — that push triggers release.yml automatically.
#
# ⚠  Branch protection: GITHUB_TOKEN can push to main only when
#    "Allow specified actors to bypass required pull requests" is enabled for
#    the github-actions[bot]. If not, create a fine-grained PAT (Contents: write)
#    stored as secret RELEASE_TOKEN and replace `secrets.GITHUB_TOKEN` below.
on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Semver increment'
        required: true
        type: choice
        options: [patch, minor, major]

jobs:
  bump:
    name: Bump ${{ inputs.bump }} → commit → tag → push
    runs-on: ubuntu-latest
    permissions:
      contents: write # push commit + tag

    steps:
      - uses: actions/checkout@v6.0.2
        with:
          # RELEASE_TOKEN must be a fine-grained PAT (Contents: write) whose
          # owner is listed in the branch-protection bypass list.
          # Create it at: Settings → Developer settings → Fine-grained tokens
          # Then add it as a repo secret named RELEASE_TOKEN.
          token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # full history so git describe finds the previous tag

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'

      # Bump only package.json — we create the commit and tag ourselves below.
      - name: Bump package.json version
        id: ver
        shell: bash
        run: |
          PREV=$(node -p "require('./package.json').version")
          echo "prev_version=${PREV}" >> "$GITHUB_OUTPUT"
          NEW_TAG=$(npm version ${{ inputs.bump }} --no-git-tag-version)
          echo "tag=${NEW_TAG}"       >> "$GITHUB_OUTPUT"
          echo "version=${NEW_TAG#v}" >> "$GITHUB_OUTPUT"

      # Prepend a new section to CHANGELOG.md with the git log since last tag.
      - name: Update CHANGELOG.md
        shell: bash
        run: |
          VER="${{ steps.ver.outputs.version }}"
          TAG="${{ steps.ver.outputs.tag }}"
          DATE=$(date -u +%Y-%m-%d)
          REPO="https://github.com/${{ github.repository }}"

          # At this point the bump commit has NOT been made yet, so HEAD is
          # still the commit that carries the previous release tag.  We find
          # the most-recent tag reachable from HEAD (= the previous release).
          PREV=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || true)

          if [ -n "$PREV" ]; then
            COMPARE_URL="${REPO}/compare/${PREV}...${TAG}"
            # Only commits that are NEW since the previous tag.
            # Exclude automated bump commits so they never pollute the next entry.
            LOG=$(git log "${PREV}..HEAD" \
              --pretty=format:"- %s" \
              --no-merges \
              2>/dev/null \
              | grep -v '^- chore(release):' \
              || true)
          else
            COMPARE_URL="${REPO}/releases/tag/${TAG}"
            LOG=$(git log \
              --pretty=format:"- %s" \
              --no-merges \
              2>/dev/null \
              | grep -v '^- chore(release):' \
              || true)
          fi

          [ -z "$LOG" ] && LOG="- (no user-facing changes)"

          # Insert new entry right after the opening title line of CHANGELOG.md
          {
            head -1 CHANGELOG.md
            printf "\n## [%s](%s) — %s\n\n%s\n" "${VER}" "${COMPARE_URL}" "${DATE}" "${LOG}"
            tail -n +2 CHANGELOG.md
          } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md

      # Mirror the new entry into the docs changelog page so the deployed
      # site is always up to date after the bump commit triggers docs.yml.
      - name: Sync changelog to docs page
        shell: bash
        run: |
          VER="${{ steps.ver.outputs.version }}"
          TAG="${{ steps.ver.outputs.tag }}"
          DATE=$(date -u +%Y-%m-%d)
          REPO="https://github.com/${{ github.repository }}"
          PREV=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || true)

          if [ -n "$PREV" ]; then
            COMPARE_URL="${REPO}/compare/${PREV}...${TAG}"
            LOG=$(git log "${PREV}..HEAD" \
              --pretty=format:"- %s" \
              --no-merges \
              2>/dev/null \
              | grep -v '^- chore(release):' \
              || true)
          else
            COMPARE_URL="${REPO}/releases/tag/${TAG}"
            LOG=$(git log \
              --pretty=format:"- %s" \
              --no-merges \
              2>/dev/null \
              | grep -v '^- chore(release):' \
              || true)
          fi

          [ -z "$LOG" ] && LOG="- (no user-facing changes)"

          ENTRY=$(printf "## [%s](%s) — %s\n\n%s\n" "${VER}" "${COMPARE_URL}" "${DATE}" "${LOG}")

          # Insert the new entry before the first existing '## [' release heading,
          # which preserves the MDX frontmatter and intro text intact.
          awk -v entry="$ENTRY" '
            /^## \[/ && !done { print entry; done=1 }
            { print }
          ' public/docs/changelog.mdx > public/docs/changelog.mdx.tmp
          mv public/docs/changelog.mdx.tmp public/docs/changelog.mdx

      # Freeze a snapshot of the current docs at the version being shipped,
      # and update the "current" label so the navbar version chip stays correct.
      # The versioned_docs/ directory is committed along with the rest below.
      - name: Install docs dependencies
        working-directory: public
        run: pnpm install --frozen-lockfile

      - name: Freeze docs snapshot & update version label
        shell: bash
        run: |
          PREV="${{ steps.ver.outputs.prev_version }}"
          NEW="${{ steps.ver.outputs.version }}"

          PREV_MINOR="${PREV%.*}"
          NEW_MINOR="${NEW%.*}"

          # Freeze docs only when the minor line changes (minor/major bump).
          # For patch bumps, keep one docs snapshot per minor line.
          if [ "${PREV_MINOR}" != "${NEW_MINOR}" ]; then
            echo "Freezing docs snapshot for ${PREV} (minor line changed: ${PREV_MINOR} -> ${NEW_MINOR})"
            cd public && pnpm docusaurus docs:version "${PREV}" && cd ..

            # Fix DE translation label for the generated frozen version.
            # Docusaurus copies 'current' translation (Aktuell), which is wrong
            # for frozen versions shown in the version switcher.
            DE_FILE="public/i18n/de/docusaurus-plugin-content-docs/version-${PREV}.json"
            if [ -f "${DE_FILE}" ]; then
              node -e "
                const fs = require('fs');
                const f = process.argv[1];
                const line = process.argv[2];
                const j = JSON.parse(fs.readFileSync(f, 'utf8'));
                if (j['version.label']) {
                  j['version.label'].message = line;
                  j['version.label'].description = 'The label for version ' + line;
                }
                fs.writeFileSync(f, JSON.stringify(j, null, 2) + '\n');
              " "${DE_FILE}" "${PREV_MINOR}"
            fi
          else
            echo "Patch bump detected (${PREV} -> ${NEW}); skipping docs snapshot freeze."
          fi

          # Update the current docs label in docusaurus.config.ts to major.minor
          node -e "
            const fs = require('fs');
            const file = 'public/docusaurus.config.ts';
            let c = fs.readFileSync(file, 'utf8');
            // Replace: current: { label: 'X.Y.Z' with the new version
            c = c.replace(
              /(current:\s*\{[^}]*label:\s*')[^']*(')/s,
              '\$1${NEW_MINOR}\$2'
            );
            fs.writeFileSync(file, c);
            console.log('Updated current.label to ${NEW_MINOR}');
          "

      - name: Commit version bump
        shell: bash
        run: |
          git add -A
          # Message prefix must match the ci.yml skip condition:
          # startsWith(head_commit.message, 'chore(release):')
          git commit -m "chore(release): v${{ steps.ver.outputs.version }}"
          # Push commit to main; release.yml triggers on main pushes and creates
          # the vX.Y.Z tag itself when publishing.
          git push origin HEAD:${{ github.ref_name }}
