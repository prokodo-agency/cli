name: Release

# Triggers on version tags, e.g. v1.2.3
on:
  push:
    tags: ['v*.*.*']

# Need write access to packages (GHCR) and contents (GitHub Release).
permissions:
  contents: write # create GitHub Release
  packages: write # push to GHCR
  id-token: write # npm provenance attestation

defaults:
  run:
    working-directory: prokodo-cli

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1 — Re-run the full CI suite on the exact tagged commit
  # ──────────────────────────────────────────────────────────────────────────
  ci:
    name: CI (all checks)
    uses: ./.github/workflows/ci.yml

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2 — Publish to npm (requires CI to pass)
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm:
    name: Publish — npm
    runs-on: ubuntu-latest
    needs: ci
    # Optional: gate on manual approval via GitHub Environments
    # environment: npm-publish

    # id-token: write is REQUIRED at job level to mint the OIDC token used for
    # npm provenance signing (the "Verified" banner on the npm package page).
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: '10'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: https://registry.npmjs.org
          cache: pnpm
          cache-dependency-path: prokodo-cli/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # Guard: ensure the git tag (e.g. v1.2.3) matches package.json version
      - name: Verify tag matches package.json version
        shell: bash
        run: |
          PKG=$(node -p "require('./package.json').version")
          TAG=${GITHUB_REF_NAME#v}
          if [ "$PKG" != "$TAG" ]; then
            echo "❌  Tag (v${TAG}) does not match package.json (${PKG})" && exit 1
          fi
          echo "✅  Version: ${PKG}"

      # Pack the tarball explicitly so we can (a) attest it and (b) publish
      # the exact same artifact that was attested — no rebuild on publish.
      - name: Pack npm tarball
        id: pack
        shell: bash
        run: |
          TARBALL=$(pnpm pack --json | node -e \
            "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d)[0].filename)")
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      # Creates a GitHub-side SLSA provenance attestation for the tarball.
      # Verifiable with: gh attestation verify <tarball> --repo <owner/repo>
      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: prokodo-cli/${{ steps.pack.outputs.tarball }}

      # Publish the pre-packed tarball with --provenance so npm signs it with
      # the OIDC token and shows the "Verified" banner on the package page.
      - name: Publish to npm (provenance → Verified banner)
        shell: bash
        run: npm publish --access public --provenance ${{ steps.pack.outputs.tarball }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3 — Build Docker image and push to GitHub Container Registry
  # ──────────────────────────────────────────────────────────────────────────
  publish-docker:
    name: Publish — Docker (GHCR)
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate semantic-version tags automatically from the git tag
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/prokodo-cli
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./prokodo-cli
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ──────────────────────────────────────────────────────────────────────────
  # Job 4 — Create GitHub Release with auto-generated changelog
  # ──────────────────────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-docker]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history for changelog generation

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          generate_release_notes: true
          make_latest: true
