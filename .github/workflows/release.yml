name: Release

# Best-practice flow: PRs validate via CI, merge to main with a release commit
# (chore(release): vX.Y.Z) triggers full publishing/deployment.
on:
  push:
    branches: [main]

# Minimal top-level permissions — each job declares only what it needs.
permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────────────────────────────────
  # Job 1 — Publish to npmjs.com (public registry)
  #
  # Uses npm Trusted Publishing (OIDC). No NPM_TOKEN secret required.
  # Prerequisite: configure this GitHub repo/workflow as a trusted publisher
  # in npm package settings for @prokodo/cli.
  #
  # Install:
  #   npm install -g @prokodo/cli
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm:
    name: Publish — npmjs.com
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    permissions:
      contents: read
      id-token: write # SLSA provenance attestation
      attestations: write # required by actions/attest-build-provenance

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          registry-url: https://registry.npmjs.org

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4.2.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Verify release version format
        shell: bash
        run: |
          VER=$(node -p "require('./package.json').version")
          if [[ ! "$VER" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ package.json version is not semver (X.Y.Z): ${VER}" >&2
            exit 1
          fi
          echo "✅ Version: ${VER}"

      # Pack once — the same tarball is attested, published, and later
      # attached to the GitHub Release as a public download for Homebrew.
      # Filename is derived from package.json to avoid parsing pnpm's stdout
      # which is polluted by prepack lifecycle script output.
      - name: Pack npm tarball
        id: pack
        shell: bash
        run: |
          SCOPE=$(node -p "require('./package.json').name.replace(/^@/,'').replace('/','-')")
          VER=$(node -p "require('./package.json').version")
          pnpm pack
          TARBALL="${SCOPE}-${VER}.tgz"
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      # SLSA provenance — verifiable with:
      #   gh attestation verify <tarball> --repo prokodo-agency/cli
      - name: Attest build provenance
        continue-on-error: true
        uses: actions/attest-build-provenance@v3.2.0
        with:
          subject-path: ${{ steps.pack.outputs.tarball }}

      - name: Check if version already exists on npmjs.com
        id: npmjs-check
        shell: bash
        run: |
          NAME=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "${NAME}@${VER}" version --registry https://registry.npmjs.org >/dev/null 2>&1; then
            echo "exists=true"  >> "$GITHUB_OUTPUT"
            echo "ℹ️ npmjs.com already has ${NAME}@${VER}; publish step will be skipped."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npmjs.com
        if: steps.npmjs-check.outputs.exists != 'true'
        run: npm publish --access public

      # Share the tarball with downstream jobs (github-release, update-homebrew)
      - name: Upload tarball as workflow artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: npm-tarball
          path: ${{ steps.pack.outputs.tarball }}
          retention-days: 1

  # ──────────────────────────────────────────────────────────────────────────
  # Job 2 — Publish to GitHub Packages (GITHUB_TOKEN — no secrets required)
  #
  # Install:
  #   npm install @prokodo/cli --registry https://npm.pkg.github.com
  # ──────────────────────────────────────────────────────────────────────────
  publish-npm-gpr:
    name: Publish — GitHub Packages
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    permissions:
      contents: read
      packages: write # push to GitHub Packages

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: pnpm/action-setup@v4.2.0
        with:
          version: '10'

      - uses: actions/setup-node@v6.2.0
        with:
          node-version: '22'
          registry-url: https://npm.pkg.github.com

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - uses: actions/cache@v4.2.2
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Check scope compatibility with GitHub Packages owner
        id: gpr-scope
        shell: bash
        run: |
          NAME=$(node -p "require('./package.json').name")
          OWNER='${{ github.repository_owner }}'
          if [[ "$NAME" == "@${OWNER}/"* ]]; then
            echo "allowed=true" >> "$GITHUB_OUTPUT"
          else
            echo "allowed=false" >> "$GITHUB_OUTPUT"
            echo "ℹ️ Skipping GitHub Packages publish: package scope '$NAME' is not owned by '${OWNER}'."
          fi

      - name: Check if version already exists on GitHub Packages
        id: gpr-check
        if: steps.gpr-scope.outputs.allowed == 'true'
        shell: bash
        run: |
          NAME=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "${NAME}@${VER}" version --registry https://npm.pkg.github.com >/dev/null 2>&1; then
            echo "exists=true"  >> "$GITHUB_OUTPUT"
            echo "ℹ️ GitHub Packages already has ${NAME}@${VER}; publish step will be skipped."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: steps.gpr-scope.outputs.allowed == 'true' && steps.gpr-check.outputs.exists != 'true'
        shell: bash
        run: npm publish --access public --registry https://npm.pkg.github.com
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ──────────────────────────────────────────────────────────────────────────
  # Job 3 — Build Docker image and push to GitHub Container Registry
  # ──────────────────────────────────────────────────────────────────────────
  publish-docker:
    name: Publish — Docker (GHCR)
    runs-on: ubuntu-latest
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6.0.2

      - uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GHCR
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute Docker tag values from package.json
        id: docker-ver
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          MAJOR=$(node -p "require('./package.json').version.split('.')[0]")
          MINOR=$(node -p "(() => { const p=require('./package.json').version.split('.'); return p[0] + '.' + p[1]; })()")
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}"     >> "$GITHUB_OUTPUT"
          echo "minor=${MINOR}"     >> "$GITHUB_OUTPUT"

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/prokodo-cli
            docker.io/prokodoagency/prokodo-cli
          tags: |
            type=raw,value=${{ steps.docker-ver.outputs.version }}
            type=raw,value=${{ steps.docker-ver.outputs.minor }}
            type=raw,value=${{ steps.docker-ver.outputs.major }}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ──────────────────────────────────────────────────────────────────────────
  # Job 4 — Create GitHub Release and attach the tarball as a public asset.
  # Waits for all three publish jobs so the release is only created after all
  # artifacts have been successfully published.
  # ──────────────────────────────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-npm-gpr, publish-docker]
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Ensure git tag exists for this version
        id: rel
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"         >> "$GITHUB_OUTPUT"

          if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q .; then
            echo "ℹ️ Tag ${TAG} already exists on origin"
          else
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "${TAG}" -m "Release ${TAG}"
            git push origin "${TAG}"
          fi

      - name: Download tarball artifact
        uses: actions/download-artifact@v4.2.1
        with:
          name: npm-tarball

      - name: Create GitHub Release (attach tarball)
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ steps.rel.outputs.tag }}
          name: ${{ steps.rel.outputs.tag }}
          generate_release_notes: true
          make_latest: true
          files: '*.tgz'

  # ──────────────────────────────────────────────────────────────────────────
  # Job 5 — Auto-update the Homebrew tap formula.
  # Points to the GitHub Release asset (public URL, no registry auth needed).
  #
  # TAP_GITHUB_TOKEN: classic PAT (repo scope) from any org member who has
  # write access to prokodo-agency/homebrew-tap.
  # ──────────────────────────────────────────────────────────────────────────
  update-homebrew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    needs: github-release
    if: startsWith(github.event.head_commit.message, 'chore(release):')

    steps:
      - uses: actions/checkout@v6.0.2

      - name: Compute release asset URL and sha256
        id: info
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          TARBALL="prokodo-cli-${VERSION}.tgz"
          URL="https://github.com/${{ github.repository }}/releases/download/${TAG}/${TARBALL}"
          SHA256=$(curl -fsSL "$URL" | shasum -a 256 | awk '{print $1}')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}"         >> "$GITHUB_OUTPUT"
          echo "url=${URL}"         >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}"   >> "$GITHUB_OUTPUT"

      - name: Checkout prokodo-agency/homebrew-tap
        uses: actions/checkout@v6.0.2
        with:
          repository: prokodo-agency/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        shell: bash
        run: |
          cd homebrew-tap
          sed -i "s|url \".*\"|url \"${{ steps.info.outputs.url }}\"|"             Formula/prokodo-cli.rb
          sed -i "s|sha256 \".*\"|sha256 \"${{ steps.info.outputs.sha256 }}\"|"   Formula/prokodo-cli.rb
          sed -i "s|version \".*\"|version \"${{ steps.info.outputs.version }}\"|" Formula/prokodo-cli.rb

      - name: Commit and push to tap
        shell: bash
        run: |
          cd homebrew-tap
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/prokodo-cli.rb
          git diff --staged --quiet || git commit -m "chore: update prokodo-cli to ${{ steps.info.outputs.tag }}"
          git push
